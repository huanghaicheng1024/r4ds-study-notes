# Data visualisation

## Introduction

我们将要学习的第一套工具，`ggplot2`的程序包，用于绘图。

首先加载`tidyverse`
```{r}
library(tidyverse)
```

## First steps

先绘制一个`mpg`数据框里边的引擎大小(`displ`)-燃油效率(`hwy`)散点图
```{r}
ggplot(data = mpg)+
  geom_point(mapping = aes(x = displ,y = hwy))
```

可以看到，绘图的模板命令大致是

```{r eval = FALSE}
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(mapping = aes(<MAPPINGS>))
```


```{r eval = FALSE}
ggplot(data = <DATA>) 
```
这是在生成一个空白图层，指定数据。


```{r eval = FALSE}
<GEOM_FUNCTION>(mapping = aes(<MAPPINGS>))
```
这是在空白图层上方继续加图层，比如前面的`geom_point`就是加上散点图图层。`mapping`是映射，是将数据框的属性映射成图形属性，常见的我们还用`aes()`，这是将将数据框的属性映射成`x,y`轴变量。

### Exercises

(1) 运行`ggplot(data = mpg)`，你会看到什么？
```{r}
ggplot(data = mpg)
```

显然，是一个空白的图层。

(2) 数据集`mpg`中有多少行？多少列？
```{r}
str(mpg)
```

利用`str `函数，可以得到数据集`mpg`中有234行11列。

(3) 变量`drv`的意义是什么？使用`?mpg`命令阅读帮助文件以找出答案。
```{r}
?mpg
```

通过阅读帮助文档可以知道

> drv: the type of drive train, where f = front-wheel drive, r = rear wheel drive, 4 = 4wd

即传动系的类型，f表示前轮驱动，r表示后轮驱动，4表示四轮驱动。

(4) 使用`hwy`和`cyl`绘制一张散点图。
```{r}
ggplot(data = mpg)+
  geom_point(mapping = aes(x = hwy,y = cyl))
```

啊，这奇怪的图形。

(5) 如果使用`class`和`drv`绘制散点图，会发生什么情况？为什么这张图没什么用处？
```{r}
ggplot(data = mpg)+
  geom_point(mapping = aes(x = class,y = drv))
```

会出现很多点重合的现象，这是这张图没什么用处的原因吗？但是自我感觉还是保留了些许信息，但的确被压缩了很多。


## Aesthetic mappings

我们在前面学习了如何把数据框属性映射为`x,y`轴，实际上还可以映射其他图形属性。

在引擎大小(`displ`)-燃油效率(`hwy`)散点图中增加多一个映射，将点的颜色映射为变量`class`
```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = class))
```


类似于点的颜色，还有的图形属性为：

- 点的透明度`alpha`

- 点的大小`size`，单位为毫米

- 点的形状`shape`，`ggplot2`只能同时使用**6**种形状

- 还可以通过`?geom_point`来查看

除了映射图形属性让`ggplot2`帮忙设置，还可以手动为几何对象设置图形属性。
```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy),colour = 'blue')
```
上图会将所有点都绘制成蓝色，因为我们并没有对点的颜色建立映射，而是直接设置。这与前面的图不同。


### Exercises

(1) 以下这段代码有什么错误？为什么点不是蓝色的？
```{r}
ggplot(data = mpg) + 
  geom_point( 
    mapping = aes(x = displ, y = hwy, color = "blue") 
  )
```

这是因为这段代码把字符串常量当作数据框属性映射为点的颜色，由于各点的值都是常量"blue"故大家的颜色也一样，为默认的第一种颜色：红色。

事实上，
```{r}
ggplot(data = mpg) + 
  geom_point( 
    mapping = aes(x = displ, y = hwy, color = "hello") 
  )
```

不论那个字符串是什么，甚至不是颜色的字符串也没有什么影响的。

(2)`mpg`中的哪些变量是分类变量？哪些变量是连续变量？（提示：输入`?mpg`来阅读这个数据集的文档。）当调用`mpg`时，如何才能看到这些信息？

当然可以阅读文档，但也可以
```{r}
str(mpg)
summary(mpg)
```

(3) 将一个连续变量映射为`color`、`size`和`shape`。对分类变量和连续变量来说，这些图形
属性的表现有什么不同？

实践是检验真理的唯一标准，我们试试看：
```{r}
ggplot(data = mpg) + 
  geom_point( 
    mapping = aes(x = displ, y = hwy, color = cty) 
  )
```

```{r}
ggplot(data = mpg) + 
  geom_point( 
    mapping = aes(x = displ, y = hwy, size = cty) 
  )
```

```{r eval=FALSE}
ggplot(data = mpg) + 
  geom_point( 
    mapping = aes(x = displ, y = hwy, shape = cty) 
  )
```

前两个还好，后面这个形状是直接报错无法映射了。毕竟`color`还有`size`都是可以渐变也即可以建立连续映射到连续的，但是形状就是铁定的离散值了，无法与连续值建立映射。

(4)如果将同一个变量映射为多个图形属性，会发生什么情况？

试试看：
```{r}
ggplot(data = mpg) + 
  geom_point( 
    mapping = aes(x = displ, y = hwy, colour = class, size = class) 
  )
```

咦，会叠加的耶。

(5)`stroke`这个图形属性的作用是什么？它适用于哪些形状？（提示：使用`?geom_point`命令。）
```{r}
?geom_point
```

但是里面没有具体涉及。实践一下
```{r}
ggplot(data = mpg) + 
  geom_point( 
    mapping = aes(x = displ, y = hwy, stroke = cty*0.2, size = cty) 
  )
```

查阅https://ggplot2.tidyverse.org/articles/ggplot2-specs.html#colour-and-fill-1， `stroke`这个图形属性是用于21-24形状的点的描边大小。

(6) 如果将图形属性映射为非变量名对象，比如`aes(color = displ < 5)`，会发生什么情况？
```{r}
ggplot(data = mpg) + 
  geom_point( 
    mapping = aes(x = displ, y = hwy, color = displ < 5) 
  )
```

嗯，还是可以映射成图形属性的。

## Common problems

这样子是错的
```{r eval=FALSE}
ggplot(data = mpg)
+geom_point(mapping = aes(x = displ, y = hwy, color = class))

```

加号要放在代码的末尾。


## Facets分面

一个参数的分面：利用函数`facet_wrap()`。例如：
```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  facet_wrap(~ class, nrow = 2)
```

每一个“面”都是属性`class`的一个值，所以**传递给`facet_wrap()`的变量应该是离散型的**。参数`nrow`表示分面的行数。

两个参数的分面：利用函数`facet_grid()`。例如：
```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  facet_grid(drv ~ cyl)
```

每一个面都由(`cyl`,`drv`)决定。

```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  facet_grid(. ~ cyl)
```

想要取消在行的维度分面，用`.`替代属性。

### Exercises

(1) 如果使用连续变量进行分面，会发生什么情况？

看一个参数的：
```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  facet_wrap(~ cty, nrow = 2)
```

可以看到它会把连续变量的所有取值都绘制分面了。

(2) 在使用`facet_grid(drv ~ cyl)`生成的图中，空白单元的意义是什么？它们和以下代码
生成的图有什么关系？
```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = drv, y = cyl))
```

而
```{r}
ggplot(data = mpg) +
  facet_grid(drv ~ cyl)
```

这个图只是对变量`drv`,`cyl`绘制分面，而上图是对这两个变量绘制散点图。

(3) 以下代码会绘制出什么图？ . 的作用是什么？

```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  facet_grid(drv ~ .) 
```

```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  facet_grid(. ~ cyl)
```

这两幅图实际上是按单个变量按列或行分面，与`facet_warp()`不同之处：
```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  facet_wrap(~ cyl)
```

`facet_warp()`对单个变量分面不会考虑按行或者按列。

(4) 查看本节的第一个分面图，
```{r echo=FALSE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  facet_wrap(~ class, nrow = 2)
```

与使用图形属性相比，使用分面的优势和劣势分别是什么？如果有一个更大的数据集，你将如何权衡这两种方法的优劣？

使用分面的优势：可以更好地看清，在固定某个变量（上图的`class`）时其余两个变量的关系。劣势就是三个变量的共同作用不太好看清了。

所以我觉得，当我们要考虑多个变量的共同作用、相互关系时可以考虑使用图形属性，当我们想要固定某个变量考虑其他变量时可以考虑分面。

(5) 阅读`?facet_wrap`的帮助页面。`nrow`和`ncol`的功能分别是什么？还有哪些选项可以控
制分面的布局？为什么函数`facet_grid()`没有变量`nrow`和`ncol`？
```{r eval=FALSE, include=FALSE}
?facet_wrap
```

`nrow`和`ncol`的功能分别是控制分面图的行列个数。函数`facet_grid()`的行列数是依赖于分面变量的取值数，所以无法自定义。

(6) 在使用函数`facet_grid()`时，一般应该将具有更多唯一值的变量放在列上。为什么这么做呢？

增加分面图的行数，从而每幅图看起来更好看、清晰，吧。


## 几何对象

几何对象是图中用来表示数据的几何图形对象，在ggplot2中使用几何对象函数来实现，比如
`geom_point(),geom_smooth()`等等，对于同一个数据对象，使用什么样的几何对象来展示，这估计也是一个大学问啊。

ggplot2中每个几何对象函数都有`mapping`参数，但并不意味着可以任意设置所有的图形属性，比如`geom_point()`就没有`linetype`属性。每个几何对象的详情可以使用帮助`?geom_point`。

### 分组绘图

使用单一几何对象实现分组绘图：

- 将一个图形属性映射为一个离散变量，自动添加图例（巨方便）
```{r}
ggplot(data = mpg) + 
  geom_smooth(mapping = aes(x = displ, y = hwy, color = drv)) 
```

- 使用`group`参数

```{r}
ggplot(data = mpg) + 
  geom_smooth(mapping = aes(x = displ, y = hwy, group = drv)) 
```


### 多个几何对象

想要在一幅图上显示多个几何对象，只需要把图层不断叠加。例如：
```{r}
ggplot(data = mpg) + 
  geom_smooth(mapping = aes(x = displ, y = hwy))+
  geom_point(mapping = aes(x = displ, y = hwy))
```


可以看到，两个几何对象的映射是重复的，可以用全局映射替代。即

```{r}
ggplot(data = mpg,mapping = aes(x = displ, y = hwy))+
  geom_point()+
  geom_smooth()
```

这样修改全局映射就会对所有几何对象有影响。

关于全局映射与局部映射：全局映射会作用与所有几何对象，局部映射只会作用与当前几何对象，并且局部映射可以拓展（不冲突时）或者覆盖全局映射（冲突时）。对于全局指定数据集以及局部指定数据集也类似。例如，
```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point(mapping = aes(color = class)) + 
  geom_smooth( 
    data = filter(mpg, class == "subcompact"), 
    se = FALSE 
  )
```

上例中，全局指定数据集与局部指定数据集冲突，所以几何对象`geom_smooth`只绘制了局部指定的数据集。局部映射`color = class`与全局映射不冲突，所以几何对象`geom_point`被三个映射作用。

### 练习

(1) 在绘制折线图、箱线图、直方图和分区图时，应该分别使用哪种几何对象？

参考： https://ggplot2.tidyverse.org/reference/index.html。 

(2) 在脑海中运行以下代码，并预测会有何种输出。接着在R中运行代码，并检查你的预测是否正确。

预测：对数据中变量`drv`不同值分别绘制散点图并绘制该散点图的平滑拟合曲线。

实际：
```{r}
ggplot( 
  data = mpg, 
  mapping = aes(x = displ, y = hwy, color = drv) 
) + 
  geom_point() + 
  geom_smooth(se = FALSE)
```

嗯，一样的。

(3) `show.legend = FALSE`的作用是什么？删除它会发生什么情况？你觉得我为什么要在本
章前面的示例中使用这句代码？

作用是不显示图例，删除它就显示图例呗。为了体现将一个图形属性映射为一个离散变量时ggplot2可以自动添加图例。

(4) `geom_smooth()`函数中的`se`参数的作用是什么？

```{r eval=FALSE}
?geom_smooth
```
可以看到`se`参数的作用是控制是否展示拟合曲线的置信区间。

(5) 以下代码生成的两张图有什么区别吗？为什么？

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point() + 
  geom_smooth() 
```
```{r}
ggplot() + 
  geom_point( 
    data = mpg, 
    mapping = aes(x = displ, y = hwy) 
  ) + 
  geom_smooth( 
    data = mpg, 
    mapping = aes(x = displ, y = hwy) 
  )
```

一样的呀，不就是把全局变量放在局部变量那里吗...

(6) 自己编写R代码来生成以下各图。

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point() + 
  geom_smooth(se=F) 
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point() + 
  geom_smooth( mapping = aes(group=drv),se=F) 
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy,color=drv)) + 
  geom_point() + 
  geom_smooth(se=F) 
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point(mapping = aes(color=drv)) + 
  geom_smooth(se=F) 
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point(mapping = aes(color=drv)) + 
  geom_smooth(se=F,mapping = aes(linetype=drv))
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point(mapping = aes(color=drv))
```

